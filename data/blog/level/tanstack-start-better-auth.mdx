---
title: Tanstack Start Better Auth Setup
date: '11-21-25'
draft: true
---

### Install NPM Package

```bash
npm install better-auth@latest
```

### Set Enviornment Variables

Generate the key with openssl.

```bash
openssl rand -base64 32
```

Then set the environment variable.

```:.env
BETTER_AUTH_SECRET=<generated secret key>
```

Set the base URL.

```:.env
BETTER_AUTH_URL=http://localhost:3000
```

### Create An Instance

```typescript:src/lib/auth.ts
import { betterAuth } from "better-auth";
export const auth = betterAuth({
  //...
});
```

Add the Drizzle adapter.

```typescript:src/lib/auth.ts {2,3,6,7,8}
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { db } from "@/db";

export const auth = betterAuth({
    database: drizzleAdapter(db, {
        provider: "pg",
    }),
});
```

### Schema

I'm going to do some restructuring of the schema files to so that I can have a separate schema file
for each model or use case such as auth.

```bash
mkdir src/db/schema
touch src/db/schema/index.ts
touch src/db/schema/auth.schema.ts
echo 'export * from "./auth.schema.ts";' > src/db/schema/index.ts
rm src/db/schema.ts
```

Update `src/db/index.ts`.

```typescript:src/db/index.ts {6}
import { config } from "dotenv";

import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

import * as schema from "./schema";

config();

const pool = new Pool({
	connectionString: process.env.DATABASE_URL!,
});
export const db = drizzle(pool, { schema });
```

Update Drizzle config.

```typescript:drizzle.config.ts {8}
import { config } from 'dotenv'
import { defineConfig } from 'drizzle-kit'

config()

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
})
```

Generate the required Better Auth schema.

```bash
npx @better-auth/cli@latest generate --config ./src/lib/auth.ts -y --output ./src/db/schema/auth.schema.ts && prettier --write ./src/db/schema/auth.schema.ts
```

Delete the `demo` folder because `todos` schema no longer exists.

```bash
rm -rf src/routes/demo
```

Generate the migration file.

```bash
npx drzzle-kit generate
```

### Authentication Method

For this app I'm going to be using email and password authentication.

```typescript:src/lib/auth.ts {10,11,12}
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { db } from "@/db";

export const auth = betterAuth({
	database: drizzleAdapter(db, {
		provider: "pg",
	}),
	emailAndPassword: {
		enabled: true,
	},
});
```

### Mount Handler

Create a catchall api route for Better Auth.

```bash
mkdir -p src/routes/api/auth && touch src/routes/api/auth/$.ts
```

```typescript:src/routes/api/auth/$.ts
import { createFileRoute } from "@tanstack/react-router";
import { auth } from "@/lib/auth";

export const Route = createFileRoute("/api/auth/$")({
	server: {
		handlers: {
			GET: async ({ request }: { request: Request }) => {
				return await auth.handler(request);
			},
			POST: async ({ request }: { request: Request }) => {
				return await auth.handler(request);
			},
		},
	},
});
```

### Create Client Instance

Create a new file `src/lib/auth-client.ts`.

````bash
touch src/lib/auth-client.ts`

```typescript:src/lib/auth-client.ts
import { createAuthClient } from "better-auth/react"
export const authClient = createAuthClient({})
````

### Usage

```typescript:src/lib/auth.ts {3,13}
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { tanstackStartCookies } from "better-auth/tanstack-start";
import { db } from "@/db";

export const auth = betterAuth({
	database: drizzleAdapter(db, {
		provider: "pg",
	}),
	emailAndPassword: {
		enabled: true,
	},
	plugins: [tanstackStartCookies()], // make sure this is the last plugin in the array
});
```
